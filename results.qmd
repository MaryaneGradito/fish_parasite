---
format:
  docx: 
    reference-doc: "./bib/template.docx"
    bibliography: "./bib/bib.ref.bib"
    csl: "./bib/behavioral-ecology.csl"
execute:
  echo: false
  error: false
  cache: false
  warning: false
crossref:  
  fig-title: Figure    # (default is "Figure")
  title-delim: â€”     # (default is ":")
  fig-prefix: Fig.   # (default is "Figure")
  tbl-prefix: Tab.   # (default is "Table")
editor_options: 
  chunk_output_type: console
---

# Results

```{r}
#| label: load_packages
#| output: false
#| warning: false

    source("./R/func.R")
    pacman::p_load(tidyverse, brms, glmmTMB, gt, latex2exp, posterior, gt, glue, dplyr,magrittr, ggplot2, cowplot, jpeg, magick)
    options(digits = 3, scipen = 2)
    
```

```{r}
#| label: load_data and models
#| output: false
#| warning: false

############################
# Import processed data
#############################
  all_data <- read.table("./output/all_data_p.csv",header=T, sep=",")

############################
# Load model
############################

  model1 <- readRDS(file = "./output/models/model1.rds")
  model1.2 <- readRDS(file = "./output/models/model1.2.rds")
  model2 <- readRDS(file = "./output/models/model2.rds")
  model2.2 <- readRDS(file = "./output/models/model2.2.rds")
  model3<-readRDS(file = "./output/models/model3.rds")
  model4 <- readRDS(file = "./output/models/model_4.rds")
  model5 <- readRDS(file = "./output/models/model_5.rds")
  model6 <- readRDS(file = "./output/models/model_6.rds")
  model7 <- readRDS(file = "./output/models/model_7.rds")
  model8<-readRDS(file = "./output/models/model_8.rds")
  model9<-readRDS(file = "./output/models/model_9.rds")

```

```{r}
#| label: Repeatability and behavioral syndromes
#| output: false
#| warning: false

############################
# Parasite count
#############################
### Blackspots distribution
  hist(all_data$BS_post_tot)

# Blackspots info
  BS_min<-min(all_data$BS_post_tot)
  BS_max<-max(all_data$BS_post_tot)
  BS_median<-median(all_data$BS_post_tot)

### Cestodes distribution
  hist(all_data$P04_alive)

# Cestodes info
  cestode_min<-min(all_data$P04_alive)
  cestode_max<-max(all_data$P04_alive)
  cestode_median<-median(all_data$P04_alive)
  mean(all_data$P04_alive)

### Nematodes distribution
  hist(all_data$P013_alive)

# Nematodes info
  nematode_min<-min(all_data$P013_alive)
  nematode_max<-max(all_data$P013_alive)

### Looking at BS gained after infection
# Create new columns in the dataset
  all_data$BS_gain<- all_data$BS_post_tot - all_data$BS_pre

# BS gain distribution
  hist(all_data$BS_gain)

# BS gain info
  gain_min<-min(all_data$BS_gain) ### miscount, some fish have less BS after infection
  gain_max<-max(all_data$BS_gain)
  gain_median<-median(all_data$BS_gain)
  gain_mean<-mean(all_data$BS_gain)


############################
# Repeatability C vs E
############################
#Extract posterior distribution for model 2, looking at repeatability
         post_sd_2 <- as_draws_df(model2, variable = "^sd", regex = TRUE)
       post_sd_C_2 <- post_sd_2[,grepl("C", colnames(post_sd_2))] #ID control
       post_sd_E_2 <- post_sd_2[,grepl("E", colnames(post_sd_2))] #ID experimental
    post_sd_cage_2 <- post_sd_2[,grepl("cage", colnames(post_sd_2))]
     post_sd_sig_2 <- as_draws_df(model2, variable = "^b_sigma", regex = TRUE)
     post_sd_sig_C_2 <- exp(post_sd_sig_2[,grepl("C", colnames(post_sd_sig_2))]) #ID control
       post_sd_sig_E_2 <- exp(post_sd_sig_2[,grepl("E", colnames(post_sd_sig_2))]) #ID experimental

############################
##     CONTROL GROUP
############################

#Boldness for control group
  fish_c_b <- post_sd_C_2[,grep("logboldness", colnames(post_sd_C_2))]^2
  cage_c_b <- post_sd_cage_2[ ,grep("logboldness", colnames(post_sd_cage_2))]^2
   res_c_b <- post_sd_sig_C_2[,grep("b_sigma_logboldness_treatmentC", colnames(post_sd_sig_C_2))]^2

  R_C_boldness <-   fish_c_b / (fish_c_b + cage_c_b + res_c_b)

#verification
 0.40^2 / (0.15^2 + 0.40^2 + exp(-0.14)^2)
 
  hist(R_C_boldness[,1])
  R_C_bold <- mean(R_C_boldness[,1])
  R_Blb_bold_C <- round(quantile(R_C_boldness[,1], c(0.025, 0.975))[1], 3)
  R_Bub_bold_C <- round(quantile(R_C_boldness[,1], c(0.025, 0.975))[2], 3)

#exploration for control group
  fish_c_ex <- post_sd_C_2[,grep("exploration", colnames(post_sd_C_2))]^2
  cage_c_ex <- post_sd_cage_2[ ,grep("exploration", colnames(post_sd_cage_2))]^2
   res_c_ex <- post_sd_sig_C_2[,grep("b_sigma_exploration_treatmentC", colnames(post_sd_sig_C_2))]^2

  R_C_exploration <-   fish_c_ex / (fish_c_ex + cage_c_ex + res_c_ex)
  
#verification
  0.57^2 / (exp(-0.11)^2 + 0.57^2 + 0.16^2) #same number

  hist(R_C_exploration[,1])
  mean(R_C_exploration[,1])
  R_Blb_exp_C <- round(quantile(R_C_exploration[,1], c(0.025, 0.975))[1], 3)
  R_Bub_exp_C <- round(quantile(R_C_exploration[,1], c(0.025, 0.975))[2], 3)

#activity for control group
  fish_c_ac <- post_sd_C_2[,grep("logactivity", colnames(post_sd_C_2))]^2
  cage_c_ac <- post_sd_cage_2[ ,grep("logactivity", colnames(post_sd_cage_2))]^2
  res_c_ac <- post_sd_sig_C_2[,grep("b_sigma_logactivity_treatmentC", colnames(post_sd_sig_C_2))]^2

  R_C_activity <-   fish_c_ac / (fish_c_ac + cage_c_ac + res_c_ac)
  
#verification
  0.64^2 / (exp(-0.15)^2 + 0.64^2 + 0.11^2) 

  hist(R_C_activity[,1])
  mean(R_C_activity[,1])
  R_Blb_act_C <- round(quantile(R_C_activity[,1], c(0.025, 0.975))[1], 3)
  R_Bub_act_C <- round(quantile(R_C_activity[,1], c(0.025, 0.975))[2], 3)

############################
# EXPERIMENTAL GROUP
############################

#Boldness for experimental group
  fish_e_b <- post_sd_E_2[,grep("logboldness", colnames(post_sd_E_2))]^2
  cage_e_b <- post_sd_cage_2[ ,grep("logboldness", colnames(post_sd_cage_2))]^2
  res_e_b <- post_sd_sig_E_2[,grep("b_sigma_logboldness_treatmentE", colnames(post_sd_sig_E_2))]^2

  R_E_boldness <-   fish_e_b / (fish_e_b + cage_e_b + res_e_b)
  
#verification
  0.42^2 / (exp(-0.11)^2 + 0.42^2 + 0.15^2)

  hist(R_E_boldness[,1])
  mean(R_E_boldness[,1])
  R_Blb_bold_E <- round(quantile(R_E_boldness[,1], c(0.025, 0.975))[1], 3)
  R_Bub_bold_E <- round(quantile(R_E_boldness[,1], c(0.025, 0.975))[2], 3)

#exploration for experimental group
   fish_e_ex <- post_sd_E_2[,grep("exploration", colnames(post_sd_E_2))]^2
  cage_e_ex <- post_sd_cage_2[ ,grep("exploration", colnames(post_sd_cage_2))]^2
  res_e_ex <- post_sd_sig_E_2[,grep("b_sigma_exploration_treatmentE", colnames(post_sd_sig_E_2))]^2

  R_E_exploration <-   fish_e_ex / (fish_e_ex + cage_e_ex + res_e_ex)
  
#verification
  0.38^2 / (exp(-0.28)^2 + 0.38^2 + 0.16^2) 

  hist(R_E_exploration[,1])
  mean(R_E_exploration[,1])
  R_Blb_exp_E <- round(quantile(R_E_exploration[,1], c(0.025, 0.975))[1], 3)
  R_Bub_exp_E <- round(quantile(R_E_exploration[,1], c(0.025, 0.975))[2], 3)

#activity for experimental group
  fish_e_ac <- post_sd_E_2[,grep("logactivity", colnames(post_sd_E_2))]^2
  cage_e_ac <- post_sd_cage_2[ ,grep("logactivity", colnames(post_sd_cage_2))]^2
  res_e_ac <- post_sd_sig_E_2[,grep("b_sigma_logactivity_treatmentE", colnames(post_sd_sig_E_2))]^2

  R_E_activity <-   fish_e_ac / (fish_e_ac + cage_e_ac + res_e_ac)

#verification
  0.51^2 / (exp(-0.26)^2 + 0.51^2 + 0.11^2) 
  
  hist(R_E_activity[,1])
  mean(R_E_activity[,1])
  R_Blb_act_E <- round(quantile(R_E_activity[,1], c(0.025, 0.975))[1], 3)
  R_Bub_act_E <- round(quantile(R_E_activity[,1], c(0.025, 0.975))[2], 3)

#############################
# Overall Repeatability
#############################

  # Boldness
   R_bold  <-  overall_repeatability(post_sd_C_2, post_sd_E_2, post_sd_cage_2, post_sd_sig_C_2, post_sd_sig_E_2, trait = "logboldness")
  
        R_bold_mean <- mean(R_bold)
        R_Blb_bold <- round(quantile(R_bold, c(0.025, 0.975))[1], 2)
        R_Bub_bold <- round(quantile(R_bold, c(0.025, 0.975))[2], 2)
        
  #Exploration
  R_exp  <-  overall_repeatability(post_sd_C_2, post_sd_E_2, post_sd_cage_2, post_sd_sig_C_2, post_sd_sig_E_2, trait = "exploration")
  
      R_exp_mean<-mean(R_exp)
       R_Blb_exp <- round(quantile(R_exp, c(0.025, 0.975))[1], 2)
       R_Bub_exp <- round(quantile(R_exp, c(0.025, 0.975))[2], 2)
       
  #Activity
  R_act  <-  overall_repeatability(post_sd_C_2, post_sd_E_2, post_sd_cage_2, post_sd_sig_C_2, post_sd_sig_E_2, trait = "logactivity")
  
  R_act_mean<-mean(R_act)
       R_Blb_act <- round(quantile(R_act, c(0.025, 0.975))[1], 2)
       R_Bub_act <- round(quantile(R_act, c(0.025, 0.975))[2], 2)

#################################
# Compare R in E and C treatments
#################################

#Is the repeatability different before and after treatment ? 
  
  #Boldness
  p_value_bold<-pmcmc((R_C_boldness[,1]) - (R_E_boldness[,1])) # Not different
  # That makes sense given:
  par(mfrow = c(1,2))
  hist(R_E_boldness[,1])
  hist(R_C_boldness[,1])
  
  #Exploration
  p_value_exp<-pmcmc((R_C_exploration[,1]) - (R_E_exploration[,1])) #not different
  
  # Histograms
  hist(R_E_exploration[,1])
  hist(R_C_exploration[,1])
  
  #Activity
  p_value_act<-pmcmc((R_C_activity[,1]) - (R_E_activity[,1])) #not different
  
   # Histograms
  hist(R_E_activity[,1])
  hist(R_C_activity[,1])
  
  
#Is the repeatability different from 5?

#Boldness control
  p_value_bold_C<-pmcmc(R_C_boldness[,1]*100, null = 5, twotail = FALSE)#not significative
#Boldness experimental
  p_value_bold_E<-pmcmc(R_E_boldness[,1]*100, null = 5, twotail = FALSE)#not significative
#Average boldness
  p_value_bold_a<-pmcmc(R_bold*100, null = 5, twotail = FALSE)#not significative but really close
  
#Exploration control
  p_value_exp_C<-pmcmc(R_C_exploration[,1]*100, null = 5, twotail = FALSE)#significative
  
  hist(R_C_exploration[,1])
  hist(R_E_exploration[,1])
#Exploration experimental
  p_value_exp_E<-pmcmc(R_E_exploration[,1]*100, null = 5, twotail = FALSE)#not significative
#Average exploration
  p_value_exp_a<-pmcmc(R_exp*100, null = 5, twotail = FALSE)#significative

#Activity control
  p_value_act_C<-pmcmc(R_C_activity[,1]*100, null = 5, twotail = FALSE)##significative
  hist(R_C_activity[,1])
#Activity experimental
  p_value_act_E<-pmcmc(R_E_activity[,1]*100, null = 5, twotail = FALSE)#significative
#Activity average
  p_value_act_a<-pmcmc(R_act*100, null = 5,twotail = FALSE) #significative
  
  
#################################
# Behavioural Syndromes
#################################
  
# Extract correlations from model 2
  post_cor  <- as_draws_df(model2, variable = "^cor", regex= TRUE)
  head(post_cor)

# Extract the C and E groups separately
  cor_bold_treatC <-   post_cor[,grep("treatmentC__[a-z]*_treatmentC", colnames(post_cor))]
  cor_bold_treatE <-   post_cor[,grep("treatmentE__[a-z]*_treatmentE", colnames(post_cor))]

# See if syndromes differ in C and E
  
  #Boldness and activity
  bsyn_b_act_C <- data.frame(cor_bold_treatC[,1]); mean(bsyn_b_act_C[,1]); quantile(bsyn_b_act_C[,1], c(0.025, 0.975))
  
  bsyn_b_act_E <- data.frame(cor_bold_treatE[,1]); mean(bsyn_b_act_E[,1]); quantile(bsyn_b_act_E[,1], c(0.025, 0.975))
  
  pmcmc_b_act_E<-pmcmc(bsyn_b_act_E[,1], twotail = TRUE)
  pmcmc_b_act_C<-pmcmc(bsyn_b_act_C[,1], twotail = TRUE)
  
  #is the difference significant
   pmcmc_b_act<-pmcmc(bsyn_b_act_C[,1] - bsyn_b_act_E[,1], twotail = TRUE) #no
  
  #Boldness and exploration
  bsyn_b_exp_C <- data.frame(cor_bold_treatC[,2]); mean(bsyn_b_exp_C[,1]); quantile(bsyn_b_exp_C[,1], c(0.025, 0.975))
  
  bsyn_b_exp_E <- data.frame(cor_bold_treatE[,2]); mean(bsyn_b_exp_E[,1]); quantile(bsyn_b_exp_E[,1], c(0.025, 0.975))
  
  #is the difference significant
  pmcmc_b_exp<-pmcmc(bsyn_b_exp_C[,1] - bsyn_b_exp_E[,1], twotail = TRUE) #no
  
  #Activity and exploration
  bsyn_act_exp_C <- data.frame(cor_bold_treatC[,3]); mean(bsyn_act_exp_C[,1]); quantile(bsyn_act_exp_C[,1], c(0.025, 0.975))
  
  pmcmc_act_exp_C<- pmcmc(bsyn_act_exp_C[,1], twotail = TRUE) #significant
  
  bsyn_act_exp_E <- data.frame(cor_bold_treatE[,3]); mean(bsyn_act_exp_E[,1]); quantile(bsyn_act_exp_E[,1], c(0.025, 0.975))  
  
   pmcmc_act_exp_E<- pmcmc(bsyn_act_exp_E[,1], twotail = TRUE) #not significant

  #is the difference significant
 pmcmc_act_exp<- pmcmc(bsyn_act_exp_C[,1] - bsyn_act_exp_E[,1], twotail = TRUE) #no
  
# Overall syndrome
  # Take average of the two treatments
    bsyn_b_act   <- cbind(bsyn_b_act_C[,1], bsyn_b_act_E[,1]); mean(rowMeans(bsyn_b_act)); quantile(rowMeans(bsyn_b_act), c(0.025, 0.975))

  # Pool the two MCMC chains from the treatments into a giant vector 32,000 rows (2*16,000)
    #Boldness and activity
bsyn_b_act2  <- rbind(c(bsyn_b_act_C[,1], bsyn_b_act_E[,1]))
mean(bsyn_b_act2)
q_b_act<-quantile(bsyn_b_act2, c(0.025, 0.975))
    
    #Boldness and exploration
bsyn_b_exp  <- rbind(c(bsyn_b_exp_C[,1], bsyn_b_exp_E[,1]))
mean(bsyn_b_exp)
q_b_exp<-quantile(bsyn_b_exp, c(0.025, 0.975))
    
    #Activity and exploration
bsyn_act_exp  <- rbind(c(bsyn_act_exp_C[,1], bsyn_act_exp_E[,1]))
mean(bsyn_act_exp)
q_act_exp<-quantile(bsyn_act_exp, c(0.025, 0.975))
    
#Values in model 1.2 for logactivity-boldness
    #estimate = -0.48
    #CI = -0.93, 0.18 ##pool is closest to model 1.2

    
```

### Methods
#### *Statistical analysis*

All statistical analyses were performed in R (vers. `r paste0(R.Version()$major, ".", R.Version()$minor)`). Adjusted fish mass was calculated as the fish mass minus parasite mass [@Lagrue_2015-wg]. Parasite mass was estimated with the mean mass of 20 parasites (Vic, in prep). For bass tapeworm, adult average mass was 0.003g and the larval form was 0.0008g. We decided to exclude nematodes since the mass varied greatly between individuals, and was rarely found in our fish. Blackspot mass was considered too small to be subtracted from total mass ($10^{-7}g$). Body condition was calculated with the Fulton index ($mass/length^3$) [@Jakob_1996-wg]. We had 4 measures of body condition, one for each trial. We used the adjusted fish mass for the 2 measures of body condition after the experimental infection (we assume there was no parasites before the experimental infection). We used standard length of the fish in centimeters. We calculated parasite load by adding the total number of blackspots post-infection with the total number of cestodes found alive (adult and larvae form). We could not determine if larvae form was alive or not visually, but we assumed it can have an effect if the larva is developing in the fish. 

Exploration was normally distributed while activity and boldness were log-transformed to better approximate normality. All variable were z-scaled (i.e., $\left(x - \bar{x} \right) / \sigma$) before fitting the models to ease model interpretation and improve parameter estimation. We fitted our models within a Bayesian statistical framework using the *brms* [vers. `r utils::packageVersion("brms")` [@Burkner2017-wg] package and *rstan* [vers. `r utils::packageVersion("rstan")`] [@noauthor_2021-az].  We ran four MCMC chains each with 6000 iterations, sampling every iteration. We discarded the first 2000 iterations as a warm up. We visually inspected chains to ensure that they were mixing well and that chains had converged (i.e., Rhat < 1.02), and ensured that we have an effective sample size >1000 for all parameters. 

To test if traits were repeatable (i.e., we had personality) and if they formed behavioural syndromes, we built a multi-responses model (n = 264, observations) with each of the three traits as response variables. Treatment (uninfected vs infected) was included as a fixed effect for each trait because we were interested in whether infection changed fish behaviour. Fish ID and cage number were included as random effects. Model 1 had tank effect as a fixed factor compared to Model 2. We compared the models using the *loo* package [vers. `r utils::packageVersion("loo")`]. Model 2 was better fitted than model 1 and we decided not to include tank effect in our models.

Repeatability (R) was calculated as:

$$
R = \frac{\sigma^{2}_{ID}}{\sigma^{2}_{ID} + \sigma^{2}_{cage} +  exp(\sigma_{R})^{2}}
$$ {#eq-eq1}

from @eq-eq1, $\sigma^{2}$ is the standard deviation from the posterior distribution from the model, ID is fish ID, cage is the cage number and sigma is distributed for each group. We also calculated repeatability across groups by pooling the posterior distribution of sigma and ID. To estimate if repeatability was different from 0, we choose 0.05 as a threshold since the values can't be 0 in the distribution. Correlation between traits were extracted from the posterior distribution of the model to determine if there was a behavioural syndrome between traits. To measure the average correlation for each group, we pooled together the two MCMC chains for both group.

To test if the experimental infection had an effect on personality, we sublet the data set according to the treatment (uninfected/pre-infection: n = 144; infected/post-infection: n = 120). We built Model 3 to see if parasite load have an effect on the traits. Parasite load was included as a fixed factor, fish ID and cage number as random factors. Model 3 assume than parasite load effect is linear, so we included parasite $load^2$ as a fixed factor in model 4. Our sample was too small to estimate model 4. 

To test if body condition as an effect on traits, we fitted model 5 with body condition as a fixed factor, ID and cage number as random effects for our uninfected group. Model 6 was fitted with parasite load and body condition for our infected group. Finally, to see if the parasite species have different effects on the traits, we built model 7 with numer of cestodes, numer of blackspots and body condition as fixed factors; ID and cage number as random factors. We suspected an interaction between body condition and parasite load and so we fitted a new model to test this. We also wanted to see if there was an interaction between the two species of parasites and we built a new model with that interaction. Both interactions were not significant and so we decided not to include them in our models. 

### Results
#### *Experimental infection*

The caging experiment successfully infected our fish. Uninfected fish that stayed in the laboratory had no living parasites, which indicated that the praziquantel treatment was effective. The two most abundant species found in the experimentally infected fish were trematodes causing the blackspot disease (Trematoda: *Apophallus sp.* and *Uvulifer sp.*; min-max: `r BS_min`- `r BS_max`; median: `r BS_median`) and the bass tapeworm (Cestoda: *Proteocephalus ambloplites*; min-max: `r cestode_min` - `r cestode_max` ; median: `r cestode_median`). The most abundant species of trematode causing blackspots was *Apophallus sp*. (Binning, Lanthier, unpublished data), but *Uvulifer sp.* was found more frequently inside the muscles (MG, personal observations). Experimental fish gained, on average, `r gain_mean` blackspots, and were found on the fins, body, gills and inside the muscles. Bass tapeworm were mostly found in the liver, stomach and digestive tract, and occasionally around the spleen (parasite count: 9), and rarely on the gills (parasite count: 3) or the heart (parasite count: 2). Other unknown nematode species were found rarely in the body cavity (alive parasite count: 4).

#### *Evidence of personality and behavioural syndromes*

Exploration and activity were repeatable across trials (Exploration: R = `r R_exp_mean`, 95% CI = `r R_Blb_exp`, `r R_Bub_exp`, $pMCMC_{\alpha = 0.05}$ = `r p_value_exp_a`; Activity: R = `r R_act_mean`, 95% CI = `r R_Blb_act`, `r R_Bub_act`, $pMCMC_{\alpha = 0.05}$ = `r p_value_act_a`), but boldness was not significantly repeatable (Boldness: R = `r R_bold_mean`, 95% CI = `r R_Blb_bold`, `r R_Bub_bold`, $pMCMC_{\alpha = 0.05}$ = `r p_value_bold_a`). We did not observe among-individual variation to be higher in the uninfected vs experimentally infected group (@tbl-tab1). Repeatability did not differ between treatment for boldness ($pMCMC_{\alpha = 0.05}$ = `r p_value_bold`), exploration ($pMCMC_{\alpha = 0.05}$ = `r p_value_exp`) and activity ($pMCMC_{\alpha = 0.05}$ = `r p_value_act`).We found evidence of behavioural syndromes between boldness and activity (cor = `r mean(bsyn_b_act2)`, 95% CI = `r q_b_act`); boldness and exploration (cor = `r mean(bsyn_b_exp)`, 95% CI = `r q_b_exp`), and between activity and exploration (cor = `r mean(bsyn_act_exp)`, 95% CI = `r q_act_exp`) (@fig-fig1).  The correlation did not differ between the uninfected and experimentally infected group for these syndromes (Boldness-Activity: $pMCMC_{\alpha = 0.05}$ =  `r pmcmc_b_act`; Boldness-Exploration: $pMCMC_{\alpha = 0.05}$ =  `r pmcmc_b_exp`; Activity-Exploration: $pMCMC_{\alpha = 0.05}$ =  `r pmcmc_act_exp`).

```{r}
#| label: tbl-tab1
#| tbl-cap: Repeatbility of boldness, exploration and activity between the uninfected and experimentally infected group
#| 
tab1 <- data.frame(Trait = c("Boldness (log)", "Exploration","Activity (log)"), 
                "Uninfected" = c(mean(R_C_boldness[,1]), mean(R_C_exploration[,1]), mean(R_C_activity[,1])), 
                  "2.5% CI (U)" = c((R_Blb_bold_C),(R_Blb_exp_C), (R_Blb_act_C)),
              "97.5% CI (U)" = c((R_Bub_bold_C), (R_Bub_exp_C),(R_Bub_act_C)),
                "Infected" = c(mean(R_E_boldness[,1]), mean(R_E_exploration[,1]), mean(R_E_activity[,1])),
              "2.5% CI (I)" = c((R_Blb_bold_E), (R_Blb_exp_E), (R_Blb_act_E)), "97.5% CI (I)" = c((R_Bub_bold_E), (R_Bub_exp_E), (R_Bub_act_E)), check.names = FALSE)

   gt(tab1)  %>% 
    tab_style(style = list(cell_text(weight = "bold")),
          locations = list(cells_column_labels())) %>% 
    opt_table_lines(extent = "none")  %>% 
    tab_style(style = cell_borders(sides = c("top", "bottom")),
          locations = list(cells_column_labels()))  %>% 
    tab_style(style = cell_borders(sides = "bottom", weight = px(2)),
         locations =  cells_body(rows = 3))

```

```{r}
#| label: fig-fig1
#| fig-cap: Behavioural syndromes between activity-boldness (A), exploration-boldness (B) and exploration-activity (C) for the uninfected and experimentally infected group
#| out-width: 100%
#| fig-width: 7
#| fig-height: 8


#Boldness and activity average between trials
dat_E <- read.table("./output/dat_models_E.csv",header=T, sep=",")
dat_C <- read.table("./output/dat_models_C.csv",header=T, sep=",")

#Boldness activity 
p1<-
   ggplot(data=dat_C)+
  geom_point(mapping = aes(x = log_boldness, y = log_activity, color = factor(ID_fish)))+ scale_color_viridis_d(option = "viridis") +
  geom_line(mapping = aes(x = log_boldness, y = log_activity, color = factor(ID_fish))) +
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Boldness_{log_{2}}$"), y = TeX("$Activity_{log_{2}}$"), title = "Uninfected") +
  annotate("text", x = -1.3, y = 2.8, label = TeX(paste0("$r_{b}$ = "," -0.52 ", " 95%CI: -0.87, -0.03")), size =3, color = "black") + 
  annotate("text", x = -1.3, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " 0.18 ", " 95%CI: -0.06, 0.40")), size=3, color = "black")

p2<-
  ggplot(data=dat_E)+
  geom_point(mapping = aes(x = log_boldness, y = log_activity, color = factor(ID_fish)))+ scale_color_viridis_d(option = "viridis") +
  geom_line(mapping = aes(x = log_boldness, y = log_activity, color = factor(ID_fish))) + 
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Boldness_{log_{2}}$"), y = TeX("$Activity_{log_{2}}$"), title = "Infected") +
  annotate("text", x = -1.5, y = 2.8, label = TeX(paste0("$r_{b}$ = ", " -0.43 ", " 95%CI: -0.84, 0.13 ")), size =3, color = "black") + 
  annotate("text", x = -1.5, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " 0.17 ", " 95%CI: -0.07, 0.39")), size=3, color = "black")
 
 p_1<- plot_grid(
  p1, p2, ncol = 2)

    #Boldness and exploration average between trials
            
  p3<-
 ggplot(data=dat_C)+
  geom_point(mapping = aes(x = log_boldness, y = exploration, color = factor(ID_fish)))+ scale_color_viridis_d(option = "viridis") +
  geom_line(mapping = aes(x = log_boldness, y = exploration, color = factor(ID_fish))) + 
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Boldness_{log_{2}}$"), y = TeX("Exploration"), title = "Uninfected") +
  annotate("text", x = -1.3, y = 2.8, label = TeX(paste0("$r_{b}$ = ", " -0.41 ", " 95%CI: -0.83, 0.11 ")), size =3, color = "black") + 
  annotate("text", x = -1.3, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " -0.06 ", " 95%CI: -0.27, 0.17")), size=3, color = "black")
  

  p4<-
    ggplot(data=dat_E)+
  geom_point(mapping = aes(x = log_boldness, y = exploration, color = factor(ID_fish)))+ scale_color_viridis_d(option = "viridis") +
  geom_line(mapping = aes(x = log_boldness, y = exploration, color = factor(ID_fish))) + 
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Boldness_{log_{2}}$"), y = TeX("Exploration"), title = "Infected") +
  annotate("text", x = 1, y = 2.8, label = TeX(paste0("$r_{b}$ = ", " -0.42 ", " 95%CI: -0.85, 0.25 ")), size =3, color = "black") + 
  annotate("text", x = 1, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " -0.12 ", " 95%CI: -0.33, 0.09")), size=3, color = "black")
    
  
   p_2<- plot_grid(
  p3, p4, ncol = 2)

    
  #Activity and exploration average between trials

    p5<-
 ggplot(data=dat_C)+
  geom_point(mapping = aes(x = log_activity, y = exploration, color = factor(ID_fish))) +
  geom_line(mapping = aes(x = log_activity, y = exploration, color = factor(ID_fish))) + 
  scale_color_viridis_d(option = "viridis")+
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Activity_{log_{2}}$"), y = TeX("Exploration"), title = "Uninfected") +
  annotate("text", x = -1.3, y = 2.8, label = TeX(paste0("$r_{b}$ = ", " 0.70 ", " 95%CI: 0.37, 0.93")), size =3, color = "black") + 
  annotate("text", x = -1.3, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " 0.19 ", " 95%CI: -0.04, 0.40")), size=3, color = "black")
  
  p6<-
    ggplot(data=dat_E)+
  geom_point(mapping = aes(x = log_activity, y = exploration, color = factor(ID_fish)))+ scale_color_viridis_d(option = "viridis") +
  geom_line(mapping = aes(x = log_activity, y = exploration, color = factor(ID_fish))) + 
   theme_classic() +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("$Activity_{log_{2}}$"), y = TeX(""), title = "Infected") +
  annotate("text", x = -1, y = 2.8, label = TeX(paste0("$r_{b}$ = ", " 0.14 ", " 95%CI: -0.43, 0.66 ")), size =3, color = "black") + 
  annotate("text", x = -1, y = 2.4, label = TeX(paste0("$r_{w}$ = ", " -0.14 ", " 95%CI: -0.35, 0.08")), size=3, color = "black")
    

  p_3<-plot_grid(
  p5, p6, ncol = 2)

pp<-plot_grid(
  p_1, p_2, p_3,
  labels = "AUTO", ncol = 1)
pp
ggsave("./output/figures/fig1.png", plot = pp, width = 28, height = 30, units = "cm")
```

```{r}
#| label: difference between uninfected and infected
#| output: false
#| warning: false

#Create dataframe with estimates and CI

#Extract post sd from model 2 for each traits and treatment
int_b <- as_draws_df(model2, variable = "^b", regex = TRUE)

#intercept for control
int_b_c<-int_b[,grep("logboldness_Intercept", colnames(int_b))]
int_exp_c<-int_b[,grep("exploration_Intercept", colnames(int_b))]
int_act_c<-int_b[,grep("logactivity_Intercept", colnames(int_b))]

#mean estimates for control
int_b_c_num<- as.numeric(unlist(int_b_c))
mean_int_b_c<-mean(int_b_c_num)

int_exp_c_num<- as.numeric(unlist(int_exp_c))
mean_int_exp_c<-mean(int_exp_c_num)

int_act_c_num<- as.numeric(unlist(int_act_c))
mean_int_act_c<-mean(int_act_c_num)

#contrast between intercept C and E
int_b_con<-int_b[,grep("b_logboldness_treatmentE", colnames(int_b))]
int_exp_con<-int_b[,grep("b_exploration_treatmentE", colnames(int_b))]
int_act_con<-int_b[,grep("b_logactivity_treatmentE", colnames(int_b))]

#mean estimates for contrast
int_b_con_num<- as.numeric(unlist(int_b_con))
mean_con_b<-mean(int_b_con_num)

blb_b_con <- round(quantile(int_b_con_num, c(0.025, 0.975))[1], 3)
bub_b_con <- round(quantile(int_b_con_num, c(0.025, 0.975))[2], 3)

int_exp_con_num<- as.numeric(unlist(int_exp_con))
mean_con_exp<-mean(int_exp_con_num)

blb_exp_con <- round(quantile(mean_con_exp, c(0.025, 0.975))[1], 3)
bub_exp_con <- round(quantile(mean_con_exp, c(0.025, 0.975))[2], 3)

int_act_con_num<- as.numeric(unlist(int_act_con))
mean_con_act<-mean(int_act_con_num)

blb_act_con <- round(quantile(mean_con_act, c(0.025, 0.975))[1], 3)
bub_act_con <- round(quantile(mean_con_act, c(0.025, 0.975))[2], 3)

#subtract intercept for C - contrast to get intercept for E
int_b_e<-(int_b_c_num + int_b_con_num)
int_b_e_num<- as.numeric(unlist(int_b_e))
mean_int_b_e<-mean(int_b_e_num)

int_exp_e<-(int_exp_con_num + int_exp_c_num)
int_exp_e_num<- as.numeric(unlist(int_exp_e))
mean_int_exp_e<-mean(int_exp_e_num)

int_act_e<-(int_act_con_num + int_act_c_num)
int_act_e_num<- as.numeric(unlist(int_act_e))
mean_int_act_e<-mean(int_act_e_num)

 
#is E and C significantly different for each trait?
pm_b<-pmcmc(int_b_c_num - int_b_e_num, twotail = TRUE) #significantly different
pm_exp<-pmcmc(int_exp_c_num - int_exp_e_num, twotail = TRUE) #significantly different
pm_act<-pmcmc(int_act_c_num - int_act_e_num, twotail = TRUE) #not significant


#95% IC
#Boldness
  #Control
blb_b_c <- round(quantile(int_b_c_num, c(0.025, 0.975))[1], 3)
bub_b_c <- round(quantile(int_b_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_b_e<- round(quantile(int_b_e, c(0.025, 0.975))[1], 3)
bub_b_e<- round(quantile(int_b_e, c(0.025, 0.975))[2], 3)

#Exploration
  #Control
blb_exp_c <- round(quantile(int_exp_c_num, c(0.025, 0.975))[1], 3)
bub_exp_c <- round(quantile(int_exp_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_exp_e <- round(quantile(int_exp_e, c(0.025, 0.975))[1], 3)
bub_exp_e <- round(quantile(int_exp_e, c(0.025, 0.975))[2], 3)

#Activity
  #Control
blb_act_c <- round(quantile(int_act_c_num, c(0.025, 0.975))[1], 3)
bub_act_c <- round(quantile(int_act_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_act_e <- round(quantile(int_act_e, c(0.025, 0.975))[1], 3)
bub_act_e <- round(quantile(int_act_e, c(0.025, 0.975))[2], 3)

```

#### *Boldness and exploration responses differ between uninfected and infected group*

Mean boldness and exploration responses in the population were significantly different between the uninfected and experimentally infected group, but not for activity (@fig-fig2). For boldness, we observe a significant decrease in the mean response in the population (Contrast = `r mean_con_b`, 95% CI = `r blb_b_con`, `r bub_b_con`, $pMCMC_{\alpha = 0.05}$ = `r pm_b`), meaning that fish tend to get bolder after the experimental infection. Fish are also significantly more exploratory in the infected group (Contrast = `r mean_con_exp`, 95% CI = `r blb_exp_con`, `r bub_exp_con`, $pMCMC_{\alpha = 0.05}$ = `r pm_exp`). Fish tend to decrease their activity in the infected group compared to the uninfected group (Contrast = `r mean_con_act`, 95% CI = `r blb_act_con`, `r bub_act_con`, $pMCMC_{\alpha = 0.05}$ = `r pm_act`)


```{r}
#| label: fig-fig2
#| fig-cap: Difference in the mean responses of boldness (A), exploration (B) and activity (C) between the uninfected and experimentally infected group
#| out-width: 100%
#| fig-width: 8
#| fig-height: 5

#Create dataframe with estimates and CI

#Extract post sd from model 2 for each traits and treatment
int_b <- as_draws_df(model2, variable = "^b", regex = TRUE)

#intercept for control
int_b_c<-int_b[,grep("logboldness_Intercept", colnames(int_b))]
int_exp_c<-int_b[,grep("exploration_Intercept", colnames(int_b))]
int_act_c<-int_b[,grep("logactivity_Intercept", colnames(int_b))]

#mean estimates for control
int_b_c_num<- as.numeric(unlist(int_b_c))
mean_int_b_c<-mean(int_b_c_num)

int_exp_c_num<- as.numeric(unlist(int_exp_c))
mean_int_exp_c<-mean(int_exp_c_num)

int_act_c_num<- as.numeric(unlist(int_act_c))
mean_int_act_c<-mean(int_act_c_num)

#contrast between intercept C and E
int_b_con<-int_b[,grep("b_logboldness_treatmentE", colnames(int_b))]
int_exp_con<-int_b[,grep("b_exploration_treatmentE", colnames(int_b))]
int_act_con<-int_b[,grep("b_logactivity_treatmentE", colnames(int_b))]

#mean estimates for contrast
int_b_con_num<- as.numeric(unlist(int_b_con))
mean_con_b<-mean(int_b_con_num)

blb_b_con <- round(quantile(int_b_con_num, c(0.025, 0.975))[1], 3)
bub_b_con <- round(quantile(int_b_con_num, c(0.025, 0.975))[2], 3)

int_exp_con_num<- as.numeric(unlist(int_exp_con))
mean_con_exp<-mean(int_exp_con_num)

blb_exp_con <- round(quantile(mean_con_exp, c(0.025, 0.975))[1], 3)
bub_exp_con <- round(quantile(mean_con_exp, c(0.025, 0.975))[2], 3)

int_act_con_num<- as.numeric(unlist(int_act_con))
mean_con_act<-mean(int_act_con_num)

blb_act_con <- round(quantile(mean_con_act, c(0.025, 0.975))[1], 3)
bub_act_con <- round(quantile(mean_con_act, c(0.025, 0.975))[2], 3)

#subtract intercept for C - contrast to get intercept for E
int_b_e<-(int_b_c_num + int_b_con_num)
int_b_e_num<- as.numeric(unlist(int_b_e))
mean_int_b_e<-mean(int_b_e_num)

int_exp_e<-(int_exp_con_num + int_exp_c_num)
int_exp_e_num<- as.numeric(unlist(int_exp_e))
mean_int_exp_e<-mean(int_exp_e_num)

int_act_e<-(int_act_con_num + int_act_c_num)
int_act_e_num<- as.numeric(unlist(int_act_e))
mean_int_act_e<-mean(int_act_e_num)

 
#is E and C significantly different for each trait?
pm_b<-pmcmc(int_b_c_num - int_b_e_num, twotail = TRUE) #significantly different
pm_exp<-pmcmc(int_exp_c_num - int_exp_e_num, twotail = TRUE) #significantly different
pm_act<-pmcmc(int_act_c_num - int_act_e_num, twotail = TRUE) #not significant


#95% IC
#Boldness
  #Control
blb_b_c <- round(quantile(int_b_c_num, c(0.025, 0.975))[1], 3)
bub_b_c <- round(quantile(int_b_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_b_e<- round(quantile(int_b_e, c(0.025, 0.975))[1], 3)
bub_b_e<- round(quantile(int_b_e, c(0.025, 0.975))[2], 3)

#Exploration
  #Control
blb_exp_c <- round(quantile(int_exp_c_num, c(0.025, 0.975))[1], 3)
bub_exp_c <- round(quantile(int_exp_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_exp_e <- round(quantile(int_exp_e, c(0.025, 0.975))[1], 3)
bub_exp_e <- round(quantile(int_exp_e, c(0.025, 0.975))[2], 3)

#Activity
  #Control
blb_act_c <- round(quantile(int_act_c_num, c(0.025, 0.975))[1], 3)
bub_act_c <- round(quantile(int_act_c_num, c(0.025, 0.975))[2], 3)
  #Experimental
blb_act_e <- round(quantile(int_act_e, c(0.025, 0.975))[1], 3)
bub_act_e <- round(quantile(int_act_e, c(0.025, 0.975))[2], 3)

#Create data frame
dat_model<-data.frame(
  trait=c("logboldness","logboldness","exploration","exploration","logactivity","logactivity"),
  treatment=c("Uninfected","Infected","Uninfected","Infected","Uninfected","Infected"), 
  estimate = c(mean_int_b_c,mean_int_b_e,mean_int_exp_c,mean_int_exp_e, mean_int_act_c, mean_int_act_e), 
  Lower_CI = c(blb_b_c, blb_b_e, blb_exp_c, blb_exp_e, blb_act_c, blb_act_e),
  Higher_CI = c(bub_b_c,bub_b_e,bub_exp_c,bub_exp_e,bub_act_c,bub_act_e))


all_data[all_data == 'C'] <- 'Uninfected'
all_data[all_data == 'E'] <- 'Infected'

#plot model2      
all_data$treatment <- factor(all_data$treatment, levels=c("Uninfected", "Infected"))
trt <- as.factor(all_data$treatment)

dat1<-dat_model %>% 
  filter(trait == "logboldness")

 
#boldness
m1<-
ggplot(all_data, aes(x = trt, y = log_boldness, group = trt, color = trt)) +
geom_violin(aes(), trim = FALSE) +
geom_jitter(aes(colour = trt),shape=16, position=position_jitter(0.1))+
scale_color_manual(labels = c("Uninfected", "Infected"), values = c("#472a7a", "#1f978b"))+
geom_errorbar(data = dat1,aes(x = treatment,y = estimate, ymin= Lower_CI, ymax=Higher_CI), width=0.2, linewidth =0.9, color = "red", inherit.aes = FALSE)+
geom_point(data=dat1, mapping=aes(x= treatment, y= estimate), size=2, shape=21, fill = "yellow", inherit.aes = FALSE)+
labs(x = (""), 
y = TeX("$Boldness_{log_{2}}$")) +
theme_classic() +
  draw_image("./img/parasite.png", x= 1.5,y = 3, scale = 0.6)+
  draw_image("./img/no_parasite.png", x= 0.5,y = 3, scale = 0.6)+
theme(legend.position = "none",
 legend.title = element_blank()) +
geom_segment(aes(x = 1, xend = 2, y = 3.85, yend = 3.85), color = "black") +
annotate("text",  x = 1.5, y = 4, label = TeX(paste0("Contrast = -0.49, $pMCMC_{\\alpha = 0.05}$ = 0.0005***")), size =2.5)


dat2<-dat_model %>% 
  filter(trait == "exploration")
trt <- as.factor(all_data$treatment)

#exploration
m2<-ggplot(all_data, aes(x = trt, y = exploration, group = trt, col = trt)) +
geom_violin(aes(), trim = FALSE) +
geom_jitter(aes(colour = trt),shape=16, position=position_jitter(0.1)) +
scale_color_manual(labels = c("Uninfected", "Infected"), values = c("#472a7a", "#1f978b"))+
geom_errorbar(data = dat2,aes(x = treatment,y = estimate, ymin= Lower_CI, ymax=Higher_CI), width=0.2, linewidth = 0.9, color = "red", inherit.aes = FALSE)+
geom_point(data=dat2, mapping=aes(x= treatment, y= estimate), size=2, shape=21, fill = "yellow", inherit.aes = FALSE)+
labs(x = "Treatment", 
y = "Exploration") +
theme_classic() +
  draw_image("./img/parasite.png", x= 1.5,y = 3, scale = 0.6)+
  draw_image("./img/no_parasite.png", x= 0.5,y = 3, scale = 0.6)+
theme(legend.position = "none",
 legend.title = element_blank()) +
geom_segment(aes(x = 1, xend = 2, y = 3.85, yend = 3.85),color = "black") +
annotate("text",  x = 1.5, y = 4, label = TeX(paste0("Contrast = 0.43, $pMCMC_{\\alpha = 0.05}$ = 0.0015**")), size =2.5)

#activity
dat3<-dat_model %>% 
  filter(trait == "logactivity")

m3<-ggplot(all_data, aes(x = trt, y = log_activity, group = trt, col = trt)) +
geom_violin(aes(), trim = FALSE) +
geom_jitter(aes(colour = trt), shape=16, position=position_jitter(0.1)) +
scale_color_manual(labels = c("Uninfected", "Infected"), values = c("#472a7a", "#1f978b"))+
geom_errorbar(data = dat3,aes(x = treatment,y = estimate, ymin= Lower_CI, ymax=Higher_CI), width=0.2, linewidth =0.9, color = "red", inherit.aes = FALSE)+
geom_point(data=dat3, mapping=aes(x= treatment, y= estimate), size=2, shape=21, fill = "yellow", inherit.aes = FALSE)+
labs(x = "", 
y = TeX("$Activity_{log_{2}}$")) +
theme_classic() +
  draw_image("./img/parasite.png", x= 1.5,y = 3, scale = 0.6)+
    draw_image("./img/no_parasite.png", x= 0.5,y = 3, scale = 0.6)+
theme(legend.position = "none",
 legend.title = element_blank()) +
geom_segment(aes(x = 1, xend = 2, y = 3.85, yend = 3.85), color = "black") +
annotate("text",  x = 1.5, y = 4, label = TeX(paste0("Contrast = -0.26, $pMCMC_{\\alpha = 0.05}$ = 0.0666")), size =2.5)

 m<-plot_grid(
  m1,m2,m3,
  labels = "AUTO", ncol = 3)

 ggsave("./output/figures/fig2.png", plot = m, width = 28, height = 13, units = "cm")

fig2 <- image_read("./output/figures/fig2.png") 
fig2

```

```{r}
#| label: parasite and body condition effects
#| output: false
#| warning: false

#################################
# MODEL 3: random slopes
#################################
# Extract correlations from model
  post_cor_3  <- as_draws_df(model3, variable = "^cor", regex= TRUE)
  head(post_cor_3)

# Extract correlations
  
  #Bold and act treatment E
  cor_bold_act_E <-   post_cor_3[,grep("cor_ID_fish__logboldness_treatmentE__logactivity_treatmentE", colnames(post_cor_3))]
  
   cor_bold_act_E<- as.numeric(unlist(cor_bold_act_E))
   cor_b_act_mean<-mean(cor_bold_act_E)
   Blb_cor_b_act_E <- round(quantile(cor_bold_act_E, c(0.025, 0.975))[1], 2)
  Bub_cor_b_act_E <- round(quantile(cor_bold_act_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_bold_act_E<- pmcmc(cor_bold_act_E, twotail = TRUE) #not significant
  
  #Bold and exploration treatment E
  cor_bold_exp_E <-   post_cor_3[,grep("cor_ID_fish__logboldness_treatmentE__exploration_treatmentE", colnames(post_cor_3))]
  pmcmc_cor_bold_exp_E<- pmcmc(cor_bold_exp_E[,1], twotail = TRUE)
  
   cor_bold_exp_E<- as.numeric(unlist(cor_bold_exp_E))
   cor_b_exp_mean<-mean(cor_bold_exp_E)
   Blb_cor_b_exp_E <- round(quantile(cor_bold_exp_E, c(0.025, 0.975))[1], 2)
  Bub_cor_b_exp_E <- round(quantile(cor_bold_exp_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_bold_exp_E<- pmcmc(cor_bold_exp_E, twotail = TRUE) #not significant
  
  #Activity and exploration E
  cor_act_exp_E <-   post_cor_3[,grep("cor_ID_fish__logactivity_treatmentE__exploration_treatmentE", colnames(post_cor_3))]
  
   cor_act_exp_E<- as.numeric(unlist(cor_act_exp_E))
   cor_act_exp_E_mean<-mean(cor_act_exp_E)
   Blb_cor_act_exp_E <- round(quantile(cor_act_exp_E, c(0.025, 0.975))[1], 2)
  Bub_cor_act_exp_E <- round(quantile(cor_act_exp_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_act_exp_E<- pmcmc(cor_act_exp_E, twotail = TRUE) #not significant
  
  
#  Bold Intercept vs Bold E
  cor_bold_I_E <-   post_cor_3[,grep("cor_ID_fish__logboldness_Intercept__logboldness_treatmentE", colnames(post_cor_3))]
  
  cor_bold_I_E<- as.numeric(unlist(cor_bold_I_E))
   cor_bold_I_E_mean<-mean(cor_bold_I_E)
   Blb_cor_bold_I_E <- round(quantile(cor_bold_I_E, c(0.025, 0.975))[1], 2)
  Bub_cor_bold_I_E <- round(quantile(cor_bold_I_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_bold_I_E<- pmcmc(cor_bold_I_E, twotail = TRUE) #not significant
  
  #Exploration I and Exp E
  cor_exp_I_E <-   post_cor_3[,grep("cor_ID_fish__exploration_Intercept__exploration_treatment", colnames(post_cor_3))]
  
  cor_exp_I_E <- as.numeric(unlist(cor_exp_I_E))
   cor_exp_I_E_mean<-mean(cor_exp_I_E)
   Blb_cor_exp_I_E <- round(quantile(cor_exp_I_E, c(0.025, 0.975))[1], 2)
  Bub_cor_exp_I_E <- round(quantile(cor_exp_I_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_exp_I_E<- pmcmc(cor_exp_I_E, twotail = TRUE) #not significant
  
#Act Intercept and act E
  cor_act_I_E <-   post_cor_3[,grep("cor_ID_fish__logactivity_Intercept__logactivity_treatmentE", colnames(post_cor_3))]
  
   cor_act_I_E <- as.numeric(unlist(cor_act_I_E))
   cor_act_I_E_mean<-mean(cor_act_I_E)
   Blb_cor_act_I_E <- round(quantile(cor_act_I_E, c(0.025, 0.975))[1], 2)
  Bub_cor_act_I_E <- round(quantile(cor_act_I_E, c(0.025, 0.975))[2], 2)
  pmcmc_cor_act_I_E<- pmcmc(cor_act_I_E, twotail = TRUE) #almost significant
  

#################################
# MODEL 4: effect of parasite on experimental group
#################################
  
#Extract post sd from model 4
post_sd_pl <- as_draws_df(model4, variable = "^b", regex = TRUE)

#extrait effect of parasite load on each traits
bold_pl<-post_sd_pl[,grep("b_logboldness_z_pl", colnames(post_sd_pl))]
exp_pl<-post_sd_pl[,grep("b_exploration_z_pl", colnames(post_sd_pl))]
act_pl<-post_sd_pl[,grep("b_logactivity_z_pl", colnames(post_sd_pl))]

  #mean and quantile for activity
  act_pl_num<- as.numeric(unlist(act_pl))
  act_pl_mean <- mean(act_pl_num)
  act_pl_Blb <- round(quantile(act_pl_num, c(0.025, 0.975))[1], 3)
  act_pl_Bub <- round(quantile(act_pl_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_act_pl<-pmcmc(act_pl_num, twotail = TRUE) #significant

  #R2
  R2_m_4 <- bayes_R2(model4, re.form = NA) #marginal
  R2_c_4 <- bayes_R2(model4) #conditional
  
  R2_act_4_m<-R2_m_4[2,1]
  R2_act_4_c<-R2_c_4[2,1]
  
    #mean and quantile for exploration
  exp_pl_num<- as.numeric(unlist(exp_pl))
  exp_pl_mean <- mean(exp_pl_num)
  exp_pl_Blb <- round(quantile(exp_pl_num, c(0.025, 0.975))[1], 3)
  exp_pl_Bub <- round(quantile(exp_pl_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_exp_pl<-pmcmc(exp_pl_num, twotail = TRUE) #significant

    #mean and quantile for boldness
  bold_pl_num <- as.numeric(unlist(bold_pl))
  bold_pl_mean <- mean(bold_pl_num)
  bold_pl_Blb <- round(quantile(bold_pl_num, c(0.025, 0.975))[1], 3)
  bold_pl_Bub <- round(quantile(bold_pl_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_bold_pl<-pmcmc(bold_pl_num, twotail = TRUE) #significant

#################################
# MODEL 5: body condition on control group
#################################
  
#Extract post sd from model 5
post_sd_bc <- as_draws_df(model5, variable = "^b", regex = TRUE)

#extrait effect of parasite load on each traits
bold_bc<-post_sd_bc[,grep("b_logboldness_z_bc", colnames(post_sd_bc))]
exp_bc<-post_sd_bc[,grep("b_exploration_z_bc", colnames(post_sd_bc))]
act_bc<-post_sd_bc[,grep("b_logactivity_z_bc", colnames(post_sd_bc))]

  #mean and quantile for activity 
  act_bc_num<- as.numeric(unlist(act_bc))
  act_bc_mean <- mean(act_bc_num)
  act_bc_Blb <- round(quantile(act_bc_num, c(0.025, 0.975))[1], 3)
  act_bc_Bub <- round(quantile(act_bc_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for activity
  p_act_bc<-pmcmc(act_bc_num, twotail = TRUE) #significant

  #R2
  R2_m_5 <- bayes_R2(model5, re.form = NA) #marginal
  R2_c_5 <- bayes_R2(model5) #conditional
  
  R2_act_5_m<-R2_m_5[2,1]
  R2_act_5_c<-R2_c_5[2,1]
  
  #mean and quantile for exploration
  exp_bc_num<- as.numeric(unlist(exp_bc))
  exp_bc_mean <- mean(exp_bc_num)
  exp_bc_Blb <- round(quantile(exp_bc_num, c(0.025, 0.975))[1], 3)
  exp_bc_Bub <- round(quantile(exp_bc_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for exploration
  p_exp_bc<-pmcmc(exp_bc_num, twotail = TRUE) 

  #mean and quantile for boldness
  bold_bc_num<- as.numeric(unlist(bold_bc))
  bold_bc_mean <- mean(bold_bc_num)
  bold_bc_Blb <- round(quantile(bold_bc_num, c(0.025, 0.975))[1], 3)
  bold_bc_Bub <- round(quantile(bold_bc_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for activity
  p_bold_bc<-pmcmc(bold_bc_num, twotail = TRUE) 

  
  
#################################
# MODEL 6: body condition and parasite load on infected fish
#################################
#Extract post sd from model 6
post_sd_pl_bc<- as_draws_df(model6, variable = "^b", regex = TRUE)

#extrait effect of body condition and parasite load on each traits
bold_bc_6<-post_sd_pl_bc[,grep("b_logboldness_z_bc", colnames(post_sd_pl_bc))]
exp_bc_6<-post_sd_pl_bc[,grep("b_exploration_z_bc", colnames(post_sd_pl_bc))]
act_bc_6<-post_sd_pl_bc[,grep("b_logactivity_z_bc", colnames(post_sd_pl_bc))]

  #mean and quantile for activity 
  act_bc_num_6<- as.numeric(unlist(act_bc_6))
  act_bc_mean_6 <- mean(act_bc_num_6)
  act_bc_Blb_6 <- round(quantile(act_bc_num_6, c(0.025, 0.975))[1], 3)
  act_bc_Bub_6 <- round(quantile(act_bc_num_6, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for activity
  p_act_bc_6<-pmcmc(act_bc_num_6, twotail = TRUE) #significant

  #R2
  R2_m_6 <- bayes_R2(model6, re.form = NA) #marginal
  R2_c_6 <- bayes_R2(model6) #conditional
  
  R2_act_6_m<-R2_m_6[2,1]
  R2_act_6_c<-R2_c_6[2,1]
  
   #mean and quantile for exploration
  exp_bc_num_6<- as.numeric(unlist(exp_bc_6))
  exp_bc_mean_6 <- mean(exp_bc_num_6)
  exp_bc_Blb_6 <- round(quantile(exp_bc_num_6, c(0.025, 0.975))[1], 3)
  exp_bc_Bub_6 <- round(quantile(exp_bc_num_6, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for activity
  p_exp_bc_6<-pmcmc(exp_bc_num_6, twotail = TRUE) #significant

   #mean and quantile for boldness
  bold_bc_num_6<- as.numeric(unlist(bold_bc))
 bold_bc_mean_6 <- mean(bold_bc_num_6)
  bold_bc_Blb_6 <- round(quantile(bold_bc_num_6, c(0.025, 0.975))[1], 3)
  bold_bc_Bub_6 <- round(quantile(bold_bc_num_6, c(0.025, 0.975))[2], 3)
  
  #pmcmc value for activity
  p_bold_bc_6<-pmcmc(bold_bc_num_6, twotail = TRUE) #significant

  
#################################
# MODEL 7: looking at two species of parasites
#################################

  #Extract post sd from model 7
post_sd_2_p <- as_draws_df(model7, variable = "^b", regex = TRUE)

#extrait effect of parasite load on each traits
bold_bs<-post_sd_2_p[,grep("b_logboldness_z_bs", colnames(post_sd_2_p))]
exp_bs<-post_sd_2_p[,grep("b_exploration_z_bs", colnames(post_sd_2_p))]
act_bs<-post_sd_2_p[,grep("b_logactivity_z_bs", colnames(post_sd_2_p))]

bold_ces<-post_sd_2_p[,grep("b_logboldness_z_ces", colnames(post_sd_2_p))]
exp_ces<-post_sd_2_p[,grep("b_exploration_z_ces", colnames(post_sd_2_p))]
act_ces<-post_sd_2_p[,grep("b_logactivity_z_ces", colnames(post_sd_2_p))]

  #blackspots
  #mean and quantile for activity
  act_bs_num<- as.numeric(unlist(act_bs))
  act_bs_mean <- mean(act_bs_num)
  act_bs_Blb <- round(quantile(act_bs_num, c(0.025, 0.975))[1], 3)
  act_bs_Bub <- round(quantile(act_bs_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_act_bs<-pmcmc(act_bs_num, twotail = TRUE) #significant

  #R2
  R2_m_7 <- bayes_R2(model7, re.form = NA) #marginal
  R2_c_7 <- bayes_R2(model7) #conditional
  
  R2_act_7_m<-R2_m_7[2,1]
  R2_act_7_c<-R2_c_7[2,1]
  
    #mean and quantile for exploration
  exp_bs_num<- as.numeric(unlist(exp_bs))
  exp_bs_mean <- mean(exp_bs_num)
  exp_bs_Blb <- round(quantile(exp_bs_num, c(0.025, 0.975))[1], 3)
  exp_bs_Bub <- round(quantile(exp_bs_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_exp_bs<-pmcmc(exp_bs_num, twotail = TRUE) #significant

    #mean and quantile for boldness
  bold_bs_num<- as.numeric(unlist(bold_bs))
  bold_bs_mean <- mean(bold_bs_num)
  bold_bs_Blb <- round(quantile(bold_bs_num, c(0.025, 0.975))[1], 3)
  bold_bs_Bub <- round(quantile(bold_bs_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_bold_bs<-pmcmc(bold_bs_num, twotail = TRUE) #significant

  ###cestodes
  #mean and quantile for activity
  act_ces_num<- as.numeric(unlist(act_ces))
  act_ces_mean <- mean(act_ces_num)
  act_ces_Blb <- round(quantile(act_ces_num, c(0.025, 0.975))[1], 3)
  act_ces_Bub <- round(quantile(act_ces_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_act_ces<-pmcmc(act_ces_num, twotail = TRUE) #significant
  
    #mean and quantile for exploration
  exp_ces_num<- as.numeric(unlist(exp_ces))
  exp_ces_mean <- mean(exp_ces_num)
  exp_ces_Blb <- round(quantile(exp_ces_num, c(0.025, 0.975))[1], 3)
  exp_ces_Bub <- round(quantile(exp_ces_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_exp_ces<-pmcmc(exp_ces_num, twotail = TRUE) #significant

    #mean and quantile for boldness
  bold_ces_num<- as.numeric(unlist(bold_ces))
  bold_ces_mean <- mean(bold_ces_num)
  bold_ces_Blb <- round(quantile(bold_ces_num, c(0.025, 0.975))[1], 3)
  bold_ces_Bub <- round(quantile(bold_ces_num, c(0.025, 0.975))[2], 3)
  
  #pmcmc value
  p_bold_ces<-pmcmc(bold_ces_num, twotail = TRUE) #significant
  
  
```

#### *Activity is positively influence by body condition*

Body condition had a positive effect on activity in both the uninfected and experimentally infected group (Uninfected: $\beta$ = `r act_bc_mean`, 95% CI = `r act_bc_Blb`, `r act_bc_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_act_bc`, $R_{m}^{2}$ = `r R2_act_5_m`, $R_{c}^{2}$ = `r R2_act_5_c`, Infected: $\beta$ = `r act_bc_mean_6`, 95% CI = `r act_bc_Blb_6`, `r act_bc_Bub_6`, $pMCMC_{\alpha = 0.05}$ = `r p_act_bc_6`, $R_{m}^{2}$ = `r R2_act_6_m`, $R_{c}^{2}$ = `r R2_act_6_c`). Body condition did not have a significant effect on exploration or boldness in the uninfected group (Exploration: $\beta$ = `r exp_bc_mean`, 95% CI = `r exp_bc_Blb`, `r exp_bc_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_exp_bc`; Boldness: $\beta$ = `r bold_bc_mean`, 95% CI = `r bold_bc_Blb`, `r bold_bc_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_bold_bc`) and infected group (Exploration: $\beta$ = `r exp_bc_mean_6`, 95% CI = `r exp_bc_Blb_6`, `r exp_bc_Bub_6`, $pMCMC_{\alpha = 0.05}$ = `r p_exp_bc_6`; Boldness: $\beta$ = `r bold_bc_mean_6`, 95% CI = `r bold_bc_Blb_6`, `r bold_bc_Bub_6`, $pMCMC_{\alpha = 0.05}$ = `r p_bold_bc_6`) (@fig-fig3).

```{r}
#| label: fig-fig3
#| fig-cap: Effect of body condition on activity in the uninfected group (A) and experimentally infected group (B)
#| out-width: 100%
#| fig-width: 8
#| fig-height: 5

#################################
# Uninfected group
#################################
dat_C <- read.table("./output/dat_models_C.csv",header=T, sep=",")

 # First we want to create a design matrix.
newdat4 <- data.frame(intercept = 1,
                        z_bc = seq(min(dat_C$z_bc), max(dat_C$z_bc), length.out = 100))

  #activity for parasite load
    pred_bc_c_brms <- posterior_epred(model5, re_formula = NA, newdata = newdat4)
  act_bc_c <- pred_bc_c_brms[,,"logactivity"]
  summ_act_bc_c <- apply(act_bc_c, 2, function(x) mean(x))
  summ_actL95_bc_c <- apply(act_bc_c, 2, function(x) quantile(x, 0.025))
  summ_actU95_bc_c <- apply(act_bc_c, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
act_bc_c_dat <- cbind(newdat4, summ_act_bc_c, summ_actL95_bc_c, summ_actU95_bc_c)

#plot
   x1<- ggplot(data=dat_C)+
  geom_point(mapping = aes(x = z_bc, y = log_activity), shape = 21,color = "#472a7a")+
 geom_smooth(data = act_bc_c_dat, ggplot2::aes(x = z_bc, y = summ_act_bc_c), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#472a7a", size=1) +
  geom_smooth(data = act_bc_c_dat, ggplot2::aes(x = z_bc, y = summ_actL95_bc_c), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#472a7a", size=0.8)+
  geom_smooth(data = act_bc_c_dat, ggplot2::aes(x = z_bc, y = summ_actU95_bc_c), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#472a7a", size=0.8)+
   theme_classic() +
    draw_image("./img/no_parasite.png", x= 2,y = 2.1, scale = 0.9)+
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("Body condition"), y = TeX("$Activity_{log_{2}}$"), title = "")+
      annotate("text", x = 0, y = 2.6, label = TeX(paste0("$beta_{bc}$ = ", " 0.21 ", " 95%CI: 0.04, 0.39**")), size =3, color = "black") 


#################################
# Infected group
#################################

  dat_parasite <- read.table("./output/dat_models_parasite.csv",header=T, sep=",")

#Predictive values for body condition in infected group
# matrix.
newdat4 <- data.frame(intercept = 1,
                        z_bc = seq(min(dat_parasite$z_bc), max(dat_parasite$z_bc), length.out = 100),
                        z_pl = 0)

  #activity for body condition
    pred_bc_brms <- posterior_epred(model6, re_formula = NA, newdata = newdat4)
  act_bc <- pred_bc_brms[,,"logactivity"]
  summ_act_bc <- apply(act_bc, 2, function(x) mean(x))
  summ_actL95_bc <- apply(act_bc, 2, function(x) quantile(x, 0.025))
  summ_actU95_bc <- apply(act_bc, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
act_bc_dat <- cbind(newdat4, summ_act_bc, summ_actL95_bc, summ_actU95_bc)

  
#plot
x2<- ggplot(data=dat_parasite)+
  geom_point(mapping = aes(x = z_bc, y = log_activity), shape = 21,color = "#1f978b")+
 geom_smooth(data = act_bc_dat, ggplot2::aes(x = z_bc, y = summ_act_bc), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#1f978b", size=1) +
  geom_smooth(data = act_bc_dat, ggplot2::aes(x = z_bc, y = summ_actL95_bc), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#1f978b", size=0.8)+
  geom_smooth(data = act_bc_dat, ggplot2::aes(x = z_bc, y = summ_actU95_bc), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#1f978b", size=0.8)+
   theme_classic() +
  draw_image("./img/parasite.png", x= 0.8,y = 1.7, scale = 0.9)+
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("Body condition"), y = TeX("$Activity_{log_{2}}$"), title = "")+
  annotate("text", x = -1, y = 2.3, label = TeX(paste0("$beta_{bc}$ = "," 0.25 ", " 95%CI: 0.08, 0.41**")), size=3, color = "black")

  
 x<- plot_grid(
  x1,x2,
  labels = "AUTO", ncol = 2)

  ggsave("./output/figures/fig3.png", plot = x, width = 28, height = 16, units = "cm")
  fig3 <- image_read("./output/figures/fig3.png")
  fig3
```

#### *Acivity decrease with parasite load following the experimental infection*

When looking at the experimentally infected fish, parasite load had a significant negative effect on activity ($\beta$ = `r act_pl_mean`, 95% CI = `r act_pl_Blb`, `r act_pl_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_act_pl`, $R_{^2}$ = 0.068). We did not capture a significant effect of parasite load on exploration and boldness (Exploration: $\beta$ = `r exp_pl_mean`, 95% CI = `r exp_pl_Blb`, `r exp_pl_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_exp_pl`; Boldness: $\beta$ = `r bold_pl_mean`, 95% CI = `r bold_pl_Blb`, `r bold_pl_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_bold_pl`). When looking at both parasites separately,surprisingly we found a significant negative effect of the number of blackspots on activity ($\beta$ = `r act_bs_mean`, 95% CI = `r act_bs_Blb`, `r act_bs_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_act_bs`, $R_{m}^{2}$ = `r R2_act_7_m`, $R_{c}^{2}$ = `r R2_act_7_c`). We find worth mentioning that the parasite species seem to have an opposite effect on each trait: cestodes tend to decrease exploration ($\beta$ = `r exp_ces_mean`, 95% CI = `r exp_ces_Blb`, `r exp_ces_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_exp_ces`) and boldness ($\beta$ = `r bold_ces_mean`, 95% CI = `r bold_ces_Blb`, `r bold_ces_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_bold_ces`), while blackspots tend to increase exploration ($\beta$ = `r exp_bs_mean`, 95% CI = `r exp_bs_Blb`, `r exp_bs_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_exp_bs`) and boldness ($\beta$ = `r bold_bs_mean`, 95% CI = `r bold_bs_Blb`, `r bold_bs_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_bold_bs`) (@fig-fig4). Activity was not impacted at all by cestodes ($\beta$ = `r act_ces_mean`, 95% CI = `r act_ces_Blb`, `r act_ces_Bub`, $pMCMC_{\alpha = 0.05}$ = `r p_act_ces`). 


```{r}
#| label: fig-fig4
#| fig-cap: Effect of cestodes, blackspots and total parasite load on boldness (A), exploration (B) and activity (C) after the experimental infection
#| out-width: 100%
#| fig-width: 4
#| fig-height: 10

#import data
dat_parasite <- read.table("./output/dat_models_parasite.csv",header=T, sep=",")

# Lets create the predictions with the posterior for each variable. Here, we want to vary ces, but keep the other variables at the mean
# First we want to create a design matrix. 
  newdat <- data.frame(intercept = 1, z_ces = seq(min(dat_parasite$z_ces), max(dat_parasite$z_ces), length.out = 100),
                        z_bs = 0,
                        z_bc = 0)

  # Now extract the posterior dist for each parameter for boldness 
    #post <- as_draws_df(model7, variables = "^b", regex = TRUE)
    #post <- post[,grep("b_logboldness", colnames(post))]

  # Make the predictions. Here, each column is now a different combination of parameters, i.e., 1 MCMC iteration), and each row is the values you want to predict, only z_ces varies
  #pred_ces <- apply(t(post), 2, function(x) as.matrix(newdat) %*% x)
  
     #sum_pred <- apply(pred_ces, 1, function(x) mean(x))
  #sum_predL95 <- apply(pred_ces, 1, function(x) quantile(x, 0.025))
  #sum_predU95 <- apply(pred_ces, 1, function(x) quantile(x, 0.975))
  
  # Now create the dataframe
  #boldness_ces_dat <- cbind(newdat, logbold = sum_pred, logbold_L95 = sum_predL95, logboldU95 = sum_predU95)

#################################
# BOLDNESS PREDICTIONS
#################################
  #Make predictions from our model to build slope and confidence intervals
  #FOR CESTODES

  pred_ces_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat)
  bold_ces <- pred_ces_brms[,,"logboldness"]
  summ_bold_ces <- apply(bold_ces, 2, function(x) mean(x))
  summ_boldL95_ces <- apply(bold_ces, 2, function(x) quantile(x, 0.025))
  summ_boldU95_ces <- apply(bold_ces, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
boldness_ces_dat <- cbind(newdat, summ_bold_ces, summ_boldL95_ces, summ_boldU95_ces)
  
  # Now, check the following is true
 #all(sum_pred == summ_bold)

  #FOR BS NOW
   newdat2 <- data.frame(intercept = 1, z_ces = 0,
                        z_bs = seq(min(dat_parasite$z_bs), max(dat_parasite$z_bs), length.out = 100),
                        z_bc = 0)

pred_bs_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat2)
  boldness_bs <- pred_bs_brms[,,"logboldness"]
  summ_bold_bs <- apply(boldness_bs, 2, function(x) mean(x))
  summ_boldL95_bs <- apply(boldness_bs, 2, function(x) quantile(x, 0.025))
  summ_boldU95_bs <- apply(boldness_bs, 2, function(x) quantile(x, 0.975))
  
boldness_bs_dat <- cbind(newdat2, summ_bold_bs, summ_boldL95_bs, summ_boldU95_bs)
  
#for parasite load
 #Predictive values for parasite load
 # matrix.
newdat5 <- data.frame(intercept = 1,
                        z_bc = 0,
                        z_pl = seq(min(dat_parasite$z_pl), max(dat_parasite$z_pl), length.out = 100))

#for parasite load
    pred_pl_brms <- posterior_epred(model6, re_formula = NA, newdata = newdat5)
  bold_pl <- pred_pl_brms[,,"logboldness"]
  summ_bold_pl <- apply(bold_pl, 2, function(x) mean(x))
  summ_boldL95_pl <- apply(bold_pl, 2, function(x) quantile(x, 0.025))
  summ_boldU95_pl <- apply(bold_pl, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
bold_pl_dat <- cbind(newdat5, summ_bold_pl, summ_boldL95_pl, summ_boldU95_pl)
  

  # Another way to do this, but you need to know that this is producting PREDICTION INTERVALS not confidence intervals....which is why these are INSANELY wide.
 # pred_ces <- predict(model7, re_formula = NA, newdata = newdat)

  # Now add the predcitions and ses to the new data
  #newdat2 <- cbind(newdat, logbold = pred_ces[,1,"logboldness"], logboldlCI = pred_ces[,3,"logboldness"], logbolduCI = pred_ces[,4,"logboldness"],
                           #logact = pred_ces[,1,"logactivity"], loglogactlCI = #pred_ces[,3,"logactivity"], loglogactUCI = pred_ces[,4,"logactivity"],
                           #explore = pred_ces[,1,"exploration"], explorelCI = pred_ces[,3,"exploration"], exploreUCI = pred_ces[,4,"exploration"])

  #figure 1
  n1<- ggplot(data=dat_parasite)+
  geom_point(mapping = aes(x = z_ces, y = log_boldness),shape = 21, color = "#365c8d")+
  geom_smooth(data = boldness_ces_dat, ggplot2::aes(x = z_ces, y = summ_bold_ces), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#365c8d", size=1) +
  geom_smooth(data = boldness_ces_dat, ggplot2::aes(x = z_ces, y = summ_boldL95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8)+
  geom_smooth(data = boldness_ces_dat, ggplot2::aes(x = z_ces, y = summ_boldU95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8) + 
    geom_point(mapping = aes(x = z_bs, y = log_boldness), shape = 21, color = "#56c667")+
  geom_smooth(data = boldness_bs_dat, ggplot2::aes(x = z_bs, y = summ_bold_bs), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#56c667", size=1) +
  geom_smooth(data = boldness_bs_dat, ggplot2::aes(x = z_bs, y = summ_boldL95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
  geom_smooth(data = boldness_bs_dat, ggplot2::aes(x = z_bs, y = summ_boldU95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
    geom_point(mapping = aes(x = z_pl, y = log_boldness),shape = 21, color = "#A2A2A2") +
   geom_smooth(data = bold_pl_dat, ggplot2::aes(x = z_pl, y = summ_bold_pl), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#A2A2A2", size=1) +
  geom_smooth(data = bold_pl_dat, ggplot2::aes(x = z_pl, y = summ_boldL95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
  geom_smooth(data = bold_pl_dat, ggplot2::aes(x = z_pl, y = summ_boldU95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
   theme_classic() +
  draw_image("./img/blackspots.png", x = 3, y = -1.2, scale = 0.8)+
    draw_image("./img/cestodes.png", x = 3, y = -0.3, scale = 0.8) +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX(""), y = TeX("$Boldness_{log_{2}}$"), title = "") +
      annotate("text", x = 1.5, y = 3.2, label = TeX(paste0("$beta_{bs}$ = ", " -0.08 ", " 95%CI: -0.28, 0.12")), size =3, color = "#56c667") + 
  annotate("text", x = 1.5, y = 3, label = TeX(paste0("$beta_{ces}$ = "," 0.11 ", " 95%CI: -0.10,0.31")), size=3, color = "#365c8d")+
   annotate("text", x = 1.5, y = 2.8, label = TeX(paste0("$beta_{pl}$ = "," -0.00 ", " 95%CI: -0.21, 0.21")), size=3, color = "black")
  
#################################
# EXPLORATION PREDICTIONS
#################################
  #for cestode
    pred_ces_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat)
  exp_ces <- pred_ces_brms[,,"exploration"]
  summ_exp_ces <- apply(exp_ces, 2, function(x) mean(x))
  summ_expL95_ces <- apply(exp_ces, 2, function(x) quantile(x, 0.025))
  summ_expU95_ces <- apply(exp_ces, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
exp_ces_dat <- cbind(newdat, summ_exp_ces, summ_expL95_ces, summ_expU95_ces)
  
  #for bs
   pred_bs_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat2)
  exp_bs <- pred_bs_brms[,,"exploration"]
  summ_exp_bs <- apply(exp_bs, 2, function(x) mean(x))
  summ_expL95_bs <- apply(exp_bs, 2, function(x) quantile(x, 0.025))
  summ_expU95_bs <- apply(exp_bs, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
exp_bs_dat <- cbind(newdat2, summ_exp_bs, summ_expL95_bs, summ_expU95_bs)
  
    #for parasite load
    pred_pl_brms <- posterior_epred(model6, re_formula = NA, newdata = newdat5)
  exp_pl <- pred_pl_brms[,,"exploration"]
  summ_exp_pl <- apply(exp_pl, 2, function(x) mean(x))
  summ_expL95_pl <- apply(exp_pl, 2, function(x) quantile(x, 0.025))
  summ_expU95_pl <- apply(exp_pl, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
exp_pl_dat <- cbind(newdat5, summ_exp_pl, summ_expL95_pl, summ_expU95_pl)
  
#figure 2
n2<-ggplot(data=dat_parasite)+
  geom_point(mapping = aes(x = z_ces, y = exploration), shape = 21, color = "#365c8d")+
 geom_smooth(data = exp_ces_dat, ggplot2::aes(x = z_ces, y = summ_exp_ces), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#365c8d", size=1) +
  geom_smooth(data = exp_ces_dat, ggplot2::aes(x = z_ces, y = summ_expL95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8)+
  geom_smooth(data = exp_ces_dat, ggplot2::aes(x = z_ces, y = summ_expU95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8)+
  geom_point(mapping = aes(x = z_bs, y = exploration), shape = 21, color = "#56c667") +
   geom_smooth(data = exp_bs_dat, ggplot2::aes(x = z_bs, y = summ_exp_bs), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#56c667", size=1) +
  geom_smooth(data = exp_bs_dat, ggplot2::aes(x = z_bs, y = summ_expL95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
  geom_smooth(data = exp_bs_dat, ggplot2::aes(x = z_bs, y = summ_expU95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
     geom_point(mapping = aes(x = z_pl, y = exploration),shape = 21, color = "#A2A2A2") +
   geom_smooth(data = exp_pl_dat, ggplot2::aes(x = z_pl, y = summ_exp_pl), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#A2A2A2", size=1) +
  geom_smooth(data = exp_pl_dat, ggplot2::aes(x = z_pl, y = summ_expL95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
  geom_smooth(data = exp_pl_dat, ggplot2::aes(x = z_pl, y = summ_expU95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
   theme_classic() +
  draw_image("./img/blackspots.png", x = 2.8, y = 0.2, scale = 0.8)+
    draw_image("./img/cestodes.png", x = 2.8, y = -0.7, scale = 0.8) +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX("Parasite load"), y = TeX("Exploration"), title = "") +
      annotate("text", x = 1.5, y = 3.2, label = TeX(paste0("$beta_{bs}$ = ", " 0.15 ", " 95%CI: -0.03, 0.32")), size =3, color = "#56c667") + 
  annotate("text", x = 1.5, y = 3, label = TeX(paste0("$beta_{ces}$ = "," -0.10 ", " 95%CI: -0.27, 0.08")), size=3, color = "#365c8d")+
   annotate("text", x = 1.5, y = 2.8, label = TeX(paste0("$beta_{pl}$ = "," 0.06 ", " 95%CI: -0.12, 0.25")), size=3, color = "black")

#################################
# ACTIVITY PREDICTIONS
#################################
  #for cestode
    pred_ces_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat)
  act_ces <- pred_ces_brms[,,"logactivity"]
  summ_act_ces <- apply(act_ces, 2, function(x) mean(x))
  summ_actL95_ces <- apply(act_ces, 2, function(x) quantile(x, 0.025))
  summ_actU95_ces <- apply(act_ces, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
act_ces_dat <- cbind(newdat, summ_act_ces, summ_actL95_ces, summ_actU95_ces)

  #for bs
   pred_bs_brms <- posterior_epred(model7, re_formula = NA, newdata = newdat2)
  act_bs <- pred_bs_brms[,,"logactivity"]
  summ_act_bs <- apply(act_bs, 2, function(x) mean(x))
  summ_actL95_bs <- apply(act_bs, 2, function(x) quantile(x, 0.025))
  summ_actU95_bs <- apply(act_bs, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
act_bs_dat <- cbind(newdat2, summ_act_bs, summ_actL95_bs, summ_actU95_bs)
  
#for parasite load
    pred_pl_brms <- posterior_epred(model6, re_formula = NA, newdata = newdat5)
  act_pl <- pred_pl_brms[,,"logactivity"]
  summ_act_pl <- apply(act_pl, 2, function(x) mean(x))
  summ_actL95_pl <- apply(act_pl, 2, function(x) quantile(x, 0.025))
  summ_actU95_pl <- apply(act_pl, 2, function(x) quantile(x, 0.975))
  
  #create dataframe
act_pl_dat <- cbind(newdat5, summ_act_pl, summ_actL95_pl, summ_actU95_pl)

  #figure 3
n3<-ggplot(data=dat_parasite)+
geom_point(mapping = aes(x = z_ces, y = log_activity), shape = 21,color = "#365c8d")+
 geom_smooth(data = act_ces_dat, ggplot2::aes(x = z_ces, y = summ_act_ces), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#365c8d", size=1) +
  geom_smooth(data = act_ces_dat, ggplot2::aes(x = z_ces, y = summ_actL95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8)+
  geom_smooth(data = act_ces_dat, ggplot2::aes(x = z_ces, y = summ_actU95_ces), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#365c8d", size=0.8)+
  geom_point(mapping = aes(x = z_bs, y = log_activity),shape = 21, color = "#56c667") +
   geom_smooth(data = act_bs_dat, ggplot2::aes(x = z_bs, y = summ_act_bs), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#56c667", size=1) +
  geom_smooth(data = act_bs_dat, ggplot2::aes(x = z_bs, y = summ_actL95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
  geom_smooth(data = act_bs_dat, ggplot2::aes(x = z_bs, y = summ_actU95_bs), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#56c667", size=0.8)+
   theme_classic() +
   geom_point(mapping = aes(x = z_pl, y = log_activity),shape = 21, color = "#A2A2A2") +
   geom_smooth(data = act_pl_dat, ggplot2::aes(x = z_pl, y = summ_act_pl), method =  "loess", formula = y~x, se = FALSE,lty = "solid", color = "#A2A2A2", size=1) +
  geom_smooth(data = act_pl_dat, ggplot2::aes(x = z_pl, y = summ_actL95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
  geom_smooth(data = act_pl_dat, ggplot2::aes(x = z_pl, y = summ_actU95_pl), method =  "loess", formula = y~x, se = FALSE,lty = "dashed", color = "#A2A2A2", size=0.8)+
  draw_image("./img/blackspots.png", x = 2.8, y = -1.4, scale = 0.8)+
    draw_image("./img/cestodes.png", x = 2.8, y = -0.6, scale = 0.8) +
    theme(strip.background = element_rect(fill = "white", colour = "white")) +
    theme(legend.position="none") + labs(x = TeX(""), y = TeX("$Activity_{log_{2}}$"), title = "")+
      annotate("text", x = 1, y = 3.2, label = TeX(paste0("$beta_{bs}$ = ", " -0.23 ", " 95%CI: -0.41, -0.06 **")), size =3, color = "#56c667") + 
  annotate("text", x = 1, y = 3, label = TeX(paste0("$beta_{ces}$ = "," 0.00 ", " 95%CI: -0.18, 0.18")), size=3, color = "#365c8d")+
   annotate("text", x = 1, y = 2.8, label = TeX(paste0("$beta_{pl}$ = "," -0.18 ", " 95%CI: -0.37, 0.01**")), size=3, color = "black")
    
p<-plot_grid(
  n1, n2, n3,
  labels = "AUTO", ncol = 3)

ggsave("./output/figures/fig4.png", plot = p, width = 40, height = 15, units = "cm")

fig4 <- image_read("./output/figures/fig4.png")
fig4
```


#### *Correlation of change between the traits*

Individuals that increased the most in their exploratory behaviour tend to have the strongest negative change in boldness ($cor_{id}$ = `r cor_b_exp_mean`, 95% CI = `r Blb_cor_b_exp_E`, `r Bub_cor_b_exp_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_bold_exp_E`). Fish that tend to have strong negative change in their boldness behaviour tend to have a positive change in their activity behaviour ($cor_{id}$ = `r cor_b_act_mean`, 95% CI = `r Blb_cor_b_act_E`, `r Bub_cor_b_act_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_bold_act_E`). We found that when a fish have a strong positive change in exploration, they tend to have a positive change in their activity as well ($cor_{id}$ = `r cor_act_exp_E_mean`, 95% CI = `r Blb_cor_act_exp_E`, `r Bub_cor_act_exp_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_act_exp_E`). Fish that were less bold (higher score in the test) tend to increase more their boldness behaviour (smaller score) compared to bolder fish ($cor_{id}$ = `r cor_bold_I_E_mean`, 95% CI = `r Blb_cor_bold_I_E`, `r Bub_cor_bold_I_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_bold_I_E`). Less exploratory fish had a larger increase in their exploratory behaviour after the experimental infection ($cor_{id}$ = `r cor_exp_I_E_mean`, 95% CI = `r Blb_cor_exp_I_E`, `r Bub_cor_exp_I_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_exp_I_E`). More active fish tend to have the strongest negative change, and the least active fish tend to have a bigger increase in activity after the experimental infection ($cor_{id}$ = `r cor_act_I_E_mean`, 95% CI = `r Blb_cor_act_I_E`, `r Bub_cor_act_I_E`, $pMCMC_{\alpha = 0.05}$ = `r pmcmc_cor_act_I_E`). 

```{r}
#| label: fig-fig5
#| fig-cap: Random slopes
#| out-width: 100%
#| fig-width: 7
#| fig-height: 4

dat_slopes <- read.table("./output/dat_slopes.csv",header=T, sep=",")

###Plot dataframe
#boldness and exploration E

k1<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=bold_E,y=exp_E), color ="cyan4", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E, y=exp_E, yend=exp_E+se_exp_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E, y=exp_E, yend=exp_E-se_exp_E), size = 0.0025,
               color="paleturquoise3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E+se_b_E, y=exp_E, yend=exp_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E-se_b_E, y=exp_E, yend=exp_E), size = 0.0025,
               color="paleturquoise3"
               ) +
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
      labs(y = TeX(paste0("Exploration", " ", "$\\beta_{id}$")),
           x = TeX(paste0("$Boldness_{log_{2}}$", " ", "$\\beta_{id}$")))+
  annotate("text", x = -1, y = -0.25, label = TeX(paste0("$cor_{id}$ = ", " -0.14 ", " 95%CI: -0.76, 0.59")), size =2.5, color = "red3")
#boldness and activity E
k2<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=bold_E,y=act_E), color ="cyan4", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E, y=act_E, yend=act_E+se_act_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E, y=act_E, yend=act_E-se_act_E), size = 0.0025,
               color="paleturquoise3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E+se_b_E, y=act_E, yend=act_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_E, xend=bold_E-se_b_E, y=act_E, yend=act_E), size = 0.0025,
               color="paleturquoise3"
               ) +
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
      labs(y = TeX(paste0("$Activity_{log_{2}}$", " ", "$\\beta_{id}$")),
           x = TeX(paste0("$Boldness_{log_{2}}$", " ", "$\\beta_{id}$")))+
    annotate("text", x = -1, y = -1.5, label = TeX(paste0("$cor_{id}$ = ", " -0.31 ", " 95%CI: -0.82, 0.42")), size =2.5, color = "red3")

#activity and exploration E
k3<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=exp_E,y=act_E), color ="cyan4", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=exp_E, xend=exp_E, y=act_E, yend=act_E+se_act_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=exp_E, xend=exp_E, y=act_E, yend=act_E-se_act_E), size = 0.0025,
               color="paleturquoise3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=exp_E, xend=exp_E+se_exp_E, y=act_E, yend=act_E), size = 0.0025,
               color="paleturquoise3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=exp_E, xend=exp_E-se_exp_E, y=act_E, yend=act_E), size = 0.0025,
               color="paleturquoise3"
               )+
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
      labs(y = TeX(paste0("$Activity_{log_{2}}$", " ", "$\\beta_{id}$")),
           x = TeX(paste0("Exploration", " ", "$\\beta_{id}$")))+
  annotate("text", x = 0.8, y = -1.5, label = TeX(paste0("$cor_{id}$ = ", " 0.25 ", " 95%CI: -0.51, 0.80")), size =2.5, color = "red3")

 
kk<- plot_grid(
  k1, k2, k3, ncol = 3)


#Boldness I  vs Bold E
k4<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=bold_I,y=bold_E), color ="darkgoldenrod", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=bold_I, xend=bold_I, y=bold_E, yend=bold_E+se_b_E), size = 0.0025, color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_I, xend=bold_I, y=bold_E, yend=bold_E-se_b_E), size = 0.0025,color ="lemonchiffon3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=bold_I, xend=bold_I+se_b_I, y=bold_E, yend=bold_E), size = 0.0025,color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=bold_I, xend=bold_I-se_b_I, y=bold_E, yend=bold_E), size = 0.0025,color ="lemonchiffon3"
               ) +
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
     labs(x = TeX(paste0("$Boldness_{log_{2}}$ Behaviour", " (personality - intercept)")),
           y = TeX(paste0("$Boldness_{log_{2}}$", " Slope ", " $\\beta_{id}$")))+
  annotate("text", x = 0.6, y = -1.3, label = TeX(paste0("$cor_{id}$ = ", " -0.20 ", " 95%CI: -0.74, 0.54")), size =2.5, color = "red3")

#Exp I  vs Exp E
k5<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=exp_I,y=exp_E), color ="darkgoldenrod", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=exp_I, xend=exp_I, y=exp_E, yend=exp_E+se_exp_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=exp_I, xend=exp_I, y=exp_E, yend=exp_E-se_exp_E), size = 0.0025,
               color ="lemonchiffon3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=exp_I, xend=exp_I+se_exp_I, y=exp_E, yend=exp_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=exp_I, xend=exp_I-se_exp_I, y=exp_E, yend=exp_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
      labs(x = TeX(paste0("Exploratory Behaviour", " (personality - intercept)")),
           y = TeX(paste0("Exploration", " Slope ", " $\\beta_{id}$")))+
  annotate("text", x = -1.0, y = -0.1, label = TeX(paste0("$cor_{id}$ = ", " -0.27 ", " 95%CI: -0.80, 0.51")), size =2.5, color = "red3")

#act I  vs act E
k6<-ggplot(data= dat_slopes)+
  theme_classic()+
  geom_point(aes(x=act_I,y=act_E), color ="darkgoldenrod", size = 3)+
  geom_segment(data =dat_slopes,
               aes(x=act_I, xend=act_I, y=act_E, yend=act_E+se_act_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=act_I, xend=act_I, y=act_E, yend=act_E-se_act_E), size = 0.0025,
               color ="lemonchiffon3"
               )+
  geom_segment(data =dat_slopes,
               aes(x=act_I, xend=act_I+se_act_I, y=act_E, yend=act_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
     geom_segment(data =dat_slopes,
               aes(x=act_I, xend=act_I-se_act_I, y=act_E, yend=act_E), size = 0.0025,
               color ="lemonchiffon3"
               ) +
  geom_vline(xintercept=0, color = "red2")+
  geom_hline(yintercept=0, color = "red2") +
      labs(x = TeX(paste0("$Activity_{log_{2}}$ Behaviour", " (personality - intercept)")),
           y = TeX(paste0("$Activity_{log_{2}}$", " Slope ", " $\\beta_{id}$")))+
   annotate("text", x = -0.8, y = -1, label = TeX(paste0("$cor_{id}$ = ", " -0.49 ", " 95%CI: -0.81, 0.11")), size =2.5, color = "red3")


 kkk<- plot_grid(
  k4, k5, k6, ncol = 3)
 
 w<-plot_grid(
  kk,kkk,
  labels = "AUTO", ncol = 1)
 
ggsave("./output/figures/fig5.png", plot = w, width = 30, height = 20, units = "cm")

fig5 <- image_read("./output/figures/fig5.png")  
fig5


```

```{r}
#| label: fig-fig6
#| fig-cap: Change in bs and bc for slope of chance in activity
#| out-width: 100%
#| fig-width: 7
#| fig-height: 4

new_data <- read.table("./output/new_data1.csv",header=T, sep=",")
#plot model 10
plot(new_data$bold_E,new_data$z_change_bs)
plot(new_data$exp_E,new_data$z_change_bs)
plot(new_data$z_change_bs, new_data$act_E)
plot(new_data$z_change_bc, new_data$act_E)
plot(new_data$bold_E,new_data$z_change_bc)
plot(new_data$exp_E,new_data$z_change_bc)

#plotting the change in bs with the change of activity, group with body condition change
ggplot(data= new_data)+
  geom_point(aes(x= z_change_bs,y=act_E, color = z_change_bc), size=3)+
  scale_fill_gradient()

```

## References

```{r}
#| label: tbl-tab2
#| tbl-cap: Raw data

all_data <- read.table("./output/all_data_p.csv",header=T, sep=",")#exploration is z transform here
all_data2 <- read.table("./data_raw/all_data.csv",header=T, sep=";")#using this dataset for exploration

#boldness uninfected
dat_boldc <- all_data %>% filter(treatment == "C")
raw_boldc_mean<-mean(dat_boldc$boldness)
raw_boldc_sd<-sd(dat_boldc$boldness)

#boldness infected
dat_bolde <- all_data %>% filter(treatment == "E")
raw_bolde_mean<-mean(dat_bolde$boldness)
raw_bolde_sd<-sd(dat_bolde$boldness)

#exploration uninfected
dat_expc <- all_data2 %>% filter(treatment == "C")
raw_expc_mean<-mean(dat_expc$exploration)
raw_expc_sd<-sd(dat_expc$exploration)

#exploration infected
dat_expe <- all_data2 %>% filter(treatment == "E")
raw_expe_mean<-mean(dat_expe$exploration)
raw_expe_sd<-sd(dat_expe$exploration)

#activity uninfected
dat_actc <- all_data %>% filter(treatment == "C")
raw_actc_mean<-mean(dat_actc$activity)
raw_actc_sd<-sd(dat_actc$activity)

#activity infected
dat_acte <- all_data %>% filter(treatment == "E")
raw_acte_mean<-mean(dat_acte$activity)
raw_acte_sd<-sd(dat_acte$activity)

#parasite load
raw_pl_mean<-mean(all_data$parasite_load)
raw_pl_sd<-sd(all_data$parasite_load)

#BS post total
raw_bs_mean<-mean(all_data$BS_post_tot)
raw_bs_sd<-sd(all_data$BS_post_tot)

#cestode total
all_data$ces_tot<- (all_data$P04_alive + all_data$P06)

raw_ces_mean<-mean(all_data$ces_tot)
raw_ces_sd<-sd(all_data$ces_tot)

#body condition uninfected
dat_bc <- read.table("./output/dat_bc.csv",header=T, sep=",") #dataset with body condition classified with trials and treatment

dat_bc_c <- dat_bc %>% filter(treatment == "C")
raw_bc_c_mean<-mean(dat_bc_c$body_condition)
raw_bc_c_sd<-sd(dat_bc_c$body_condition)

#body condition infected
dat_bc_e <- dat_bc %>% filter(treatment == "E")
raw_bc_e_mean<-mean(dat_bc_e$body_condition)
raw_bc_e_sd<-sd(dat_bc_e$body_condition)

#table with raw mean and sd for the variables

tab2 <- data.frame("Raw variables" = c("Boldness (sec)", "Exploration (%)","Activity (cm)","Body condition (mass/length^3)", "Parasite load (no)", "Blackspots (no)","Cestodes (no)"), 
                  "Mean uninfected" = c(raw_boldc_mean,raw_expc_mean,raw_actc_mean,raw_bc_c_mean,NA,NA,NA), "Standard deviation uninfected" = c(raw_boldc_sd,raw_expc_sd,raw_actc_sd,raw_bc_c_sd,NA,NA,NA),
                  "Mean infected" = c(raw_bolde_mean,raw_expe_mean,raw_acte_mean,raw_bc_e_mean,raw_pl_mean,raw_bs_mean,raw_ces_mean), "Standard deviation infected" = c(raw_bolde_sd,raw_expe_sd,raw_acte_sd,raw_bc_e_sd,raw_pl_sd,raw_bs_sd,raw_ces_sd),
                  check.names = FALSE)

   gt(tab2)  %>% 
    tab_style(style = list(cell_text(weight = "bold")),
          locations = list(cells_column_labels())) %>% 
    opt_table_lines(extent = "none")  %>% 
    tab_style(style = cell_borders(sides = c("top", "bottom")),
          locations = list(cells_column_labels()))  %>% 
    tab_style(style = cell_borders(sides = "bottom", weight = px(2)),
         locations =  cells_body(rows = 7))

```

